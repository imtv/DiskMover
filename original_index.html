<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>115 Task Master Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --bg: #f3f4f6; --card: #fff; --text: #1f2937; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* Main App */
        .app-container { max-width: 800px; margin: 40px auto; width: 90%; flex: 1; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--card); padding: 24px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Forms */
        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #e5e7eb; border-radius: 6px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 600; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-outline { background: transparent; color: var(--text); border: 1px solid #e5e7eb; }
        .btn-danger { background: #ef4444; color: white; border: none; }
        .btn-edit { background: #3b82f6; color: white; border: none; }
        .btn-run { background: #10b981; color: white; border: none; } /* æ–°å¢è¿è¡ŒæŒ‰é’®æ ·å¼ */
        .btn-refresh { background: #8b5cf6; color: white; border: none; } /* æ‰«ææŒ‰é’®æ ·å¼ */
        
        /* Task List */
        .task-item { background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ccc; }
        .task-item.running { border-left-color: #3b82f6; }
        .task-item.success { border-left-color: #10b981; }
        .task-item.error { border-left-color: #ef4444; }
        .task-item.scheduled { border-left-color: #8b5cf6; } /* å®šæ—¶ä»»åŠ¡é¢œè‰² */

        .task-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-link { font-size: 1.05rem; font-weight: 600; color: var(--primary); text-decoration: none; display: inline-block; margin-bottom: 4px; }
        .task-link:hover { text-decoration: underline; }
        .task-meta { font-size: 0.85rem; color: #6b7280; display: flex; gap: 10px; margin-bottom: 6px; }
        .task-log { font-size: 0.8rem; color: #4b5563; background: #e5e7eb; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 4px;}

        .cron-preview { font-family: monospace; background: #1f2937; color: #10b981; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.85rem; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 450px; max-height: 80vh; display: flex; flex-direction: column; overflow-y: auto; }
        
        .row { display: flex; gap: 10px; }
        .file-item:hover { background-color: #f3f4f6; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <h3>ğŸ¤– 115 è½¬å­˜æœºå™¨äºº</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="scanBaidu()" class="btn-refresh" style="width: auto; padding: 6px 12px; font-size: 0.85rem;">æ‰«æç™¾åº¦ç½‘ç›˜</button>
                <button onclick="openAdminModal()" class="btn-outline" style="width: auto; padding: 6px 12px; font-size: 0.85rem;">âš™ï¸ ç®¡ç†åå°</button>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜è®¾ç½®é¢æ¿ (é»˜è®¤éšè—) -->
        <div class="card" id="adminPanel" style="display:none; border: 2px solid #3b82f6;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 style="margin:0;">ğŸ”§ ç®¡ç†å‘˜è®¾ç½®</h4>
                <button onclick="logoutAdmin()" class="btn-danger" style="width:auto; padding:4px 10px; font-size:0.8rem;">é€€å‡ºç™»å½•</button>
            </div>
            <div style="margin-bottom: 10px;">
                <label style="font-size:0.8rem;">115 Cookie</label>
                <input type="text" id="cookieInput" placeholder="è¾“å…¥ Cookie (UID/CID/SEID...)">
            </div>

            <div style="margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                <label style="font-size:0.8rem; font-weight:bold;">âš™ï¸ åŠŸèƒ½å¼€å…³</label>
                <div style="margin-top:5px;">
                    <label><input type="checkbox" id="setEnableCronFeature" style="width:auto;"> å¯ç”¨å®šæ—¶ä»»åŠ¡åŠŸèƒ½ (å…¨å±€)</label>
                </div>
            </div>
            
            <div style="margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                <label style="font-size:0.8rem; font-weight:bold;">ğŸ“‚ åˆ†ç±»ä¿å­˜è·¯å¾„è®¾ç½®</label>
                
                <div style="margin-top:5px;"><label style="font-size:0.75rem;">ğŸ“º ç”µè§†å‰§</label></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="catTvName" readonly style="background:#eee; margin-bottom:5px;">
                    <button onclick="openFolderPicker('tv')" class="btn-outline" style="width:60px; margin-bottom:5px;">é€‰æ‹©</button>
                </div>
                
                <div style="margin-top:5px;"><label style="font-size:0.75rem;">ğŸ¬ ç”µå½±</label></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="catMovieName" readonly style="background:#eee; margin-bottom:5px;">
                    <button onclick="openFolderPicker('movie')" class="btn-outline" style="width:60px; margin-bottom:5px;">é€‰æ‹©</button>
                </div>

                <div style="margin-top:5px;"><label style="font-size:0.75rem;">ğŸ¤ ç»¼è‰º</label></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="catVarietyName" readonly style="background:#eee; margin-bottom:5px;">
                    <button onclick="openFolderPicker('variety')" class="btn-outline" style="width:60px; margin-bottom:5px;">é€‰æ‹©</button>
                </div>

                <div style="margin-top:5px;"><label style="font-size:0.75rem;">ğŸŒ¸ åŠ¨æ¼«</label></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="catAnimeName" readonly style="background:#eee; margin-bottom:5px;">
                    <button onclick="openFolderPicker('anime')" class="btn-outline" style="width:60px; margin-bottom:5px;">é€‰æ‹©</button>
                </div>

                <div style="margin-top:5px;"><label style="font-size:0.75rem;">ğŸ“¦ å…¶ä»–</label></div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="catOtherName" readonly style="background:#eee; margin-bottom:5px;">
                    <button onclick="openFolderPicker('other')" class="btn-outline" style="width:60px; margin-bottom:5px;">é€‰æ‹©</button>
                </div>
            </div>

            <div style="margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                <label style="font-size:0.8rem;">OpenList é›†æˆ (æ‰‹åŠ¨æ‰«æ)</label>
                <input type="text" id="olUrl" placeholder="OpenList åœ°å€ (å¦‚ http://192.168.1.5:5244)">
                <input type="text" id="olToken" placeholder="API Token (åå°-è®¾ç½®-å…¶ä»–-ä»¤ç‰Œ)">
                <div class="row">
                    <div style="flex:1">
                        <label style="font-size:0.7rem; color:#666;">OpenList æŒ‚è½½è·¯å¾„ (å¯¹åº”ä¸Šæ–¹æ ¹ç›®å½•)</label>
                        <input type="text" id="olMountPrefix" placeholder="ä¾‹å¦‚ /115ç½‘ç›˜ (å°†è‡ªåŠ¨æ›¿æ¢æ ¹ç›®å½•è·¯å¾„)">
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                <label style="font-size:0.8rem;">ç®¡ç†å‘˜è´¦å·è®¾ç½®</label>
                <div class="row">
                    <input type="text" id="setAdminUser" placeholder="ç”¨æˆ·å">
                    <input type="text" id="setAdminPass" placeholder="å¯†ç ">
                </div>
            </div>
            <button onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        </div>

        <div class="card">
            <h3>â• æ–°å»ºæ™ºèƒ½ä»»åŠ¡</h3>
            <div style="font-size:0.85rem; color:#666; margin-bottom:12px; background:#f3f4f6; padding:8px; border-radius:6px;">
                ğŸ’¡ <b>æç¤º</b>ï¼šä»»åŠ¡åç§°ä¸ºå¿…å¡«é¡¹ï¼Œç”¨äºé‡å‘½åè½¬å­˜åçš„æ–‡ä»¶å¤¹ã€‚
            </div>
            
            <label style="font-size:0.8rem; color:#666;">è§†é¢‘åç§°</label>
            <div class="row">
                <input type="text" id="taskName" placeholder="å¿…å¡«">
            </div>
            
            <label style="font-size:0.8rem; color:#666;">åˆ†äº«é“¾æ¥</label>
            <input type="text" id="shareUrl" placeholder="https://115cdn.com/s/...">
            
            <label style="font-size:0.8rem; color:#666;">æå–ç </label>
            <input type="text" id="accessCode" placeholder="å¯é€‰">

            <div style="margin-bottom: 15px;">
                <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:5px;">ä¿å­˜åˆ†ç±» (è‡ªåŠ¨é‡å‘½åæ–‡ä»¶å¤¹)</label>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <label><input type="radio" name="category" value="tv" style="width:auto;"> ğŸ“º ç”µè§†å‰§</label>
                    <label><input type="radio" name="category" value="movie" style="width:auto;"> ğŸ¬ ç”µå½±</label>
                    <label><input type="radio" name="category" value="variety" style="width:auto;"> ğŸ¤ ç»¼è‰º</label>
                    <label><input type="radio" name="category" value="anime" style="width:auto;"> ğŸŒ¸ åŠ¨æ¼«</label>
                    <label><input type="radio" name="category" value="other" style="width:auto;"> ğŸ“¦ å…¶ä»–</label>
                </div>
            </div>

            <div id="createTaskCronSection" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #bae6fd; display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <label style="font-size:0.9rem; font-weight:700; color:#0369a1; margin:0;">â±ï¸ å®šæ—¶æ£€æŸ¥æ›´æ–°</label>
                    <label style="font-size:0.85rem; color:#0284c7; display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" id="enableCron" onchange="toggleCronInput()" style="width:auto; margin:0;"> å¯ç”¨å®šæ—¶
                    </label>
                </div>
                <div id="cronInputBox" style="display:none;">
                    <input type="text" id="cron_hours" placeholder="ä¾‹å¦‚: 8,20 (ä»£è¡¨æ¯å¤©8ç‚¹å’Œ20ç‚¹)" oninput="updateCronPreview('create')">
                    <div class="cron-preview" id="cronResult">æ‰§è¡Œç­–ç•¥: ä»…ä¸€æ¬¡ (ç«‹å³æ‰§è¡Œ)</div>
                </div>
            </div>

            <button onclick="createTask()">ğŸš€ å¼€å§‹ä»»åŠ¡</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ“‹ ä»»åŠ¡é˜Ÿåˆ—</h3>
                <button id="btnClearAll" onclick="clearAllTasks()" class="btn-danger" style="width:auto; padding:4px 10px; font-size:0.8rem; display:none;">ğŸ—‘ï¸ æ¸…ç©ºé˜Ÿåˆ—</button>
            </div>
            <div id="taskList"></div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <strong>âœï¸ ç¼–è¾‘ä»»åŠ¡</strong>
                <span onclick="document.getElementById('editModal').style.display='none'" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            
            <input type="hidden" id="editTaskId">
            
            <label style="font-size:0.8rem; color:#666;">ä»»åŠ¡åç§°</label>
            <input type="text" id="editTaskName" placeholder="ä»»åŠ¡åç§°">
            
            <label style="font-size:0.8rem; color:#666;">åˆ†äº«é“¾æ¥</label>
            <input type="text" id="editShareUrl" placeholder="åˆ†äº«é“¾æ¥">
            
            <label style="font-size:0.8rem; color:#666;">æå–ç </label>
            <input type="text" id="editAccessCode" placeholder="æå–ç  (å¯é€‰)">
            
            <div id="editTaskCronSection" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #bae6fd; display:none;">
                <label style="font-size:0.9rem; font-weight:700; color:#0369a1; display:flex; justify-content:space-between;">
                    <span>â±ï¸ æ¯å¤©å®šæ—¶æ£€æŸ¥ (å°æ—¶)</span>
                    <span style="font-weight:400; font-size:0.8rem; color:#0284c7; cursor:pointer;" onclick="clearCron('edit')">[ é‡ç½® ]</span>
                </label>
                <div style="margin-top: 10px;">
                    <input type="text" id="edit_cron_hours" placeholder="ä¾‹å¦‚: 8,20 (ä»£è¡¨æ¯å¤©8ç‚¹å’Œ20ç‚¹)" oninput="updateCronPreview('edit')">
                    <div class="cron-preview" id="editCronResult">æ‰§è¡Œç­–ç•¥: æœªå˜æ›´</div>
                </div>
            </div>

            <button onclick="updateTask()">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content" style="width: 300px;">
            <h3 style="margin-top:0;">ç®¡ç†å‘˜éªŒè¯</h3>
            <input type="text" id="adminUser" placeholder="ç”¨æˆ·å (é»˜è®¤ admin)" style="margin-bottom:10px;">
            <input type="password" id="adminPwd" placeholder="å¯†ç  (é»˜è®¤ admin)">
            <button onclick="doAdminLogin()">ç¡®è®¤</button>
            <button onclick="document.getElementById('adminLoginModal').style.display='none'" class="btn-outline" style="margin-top:10px;">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="folderModal" class="modal">
        <div class="modal-content" style="width: 600px; max-height: 85vh;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <strong>ğŸ“‚ æ–‡ä»¶ç®¡ç†</strong>
                <span onclick="document.getElementById('folderModal').style.display='none'" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            
            <!-- Toolbar -->
            <div style="display:flex; gap:10px; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #eee; align-items: center;">
                <input type="text" id="newFolderName" placeholder="æ–°å»ºæ–‡ä»¶å¤¹åç§°" style="margin-bottom:0; font-size:0.9rem; flex:1; padding: 0 10px; height: 38px;">
                <button onclick="createNewFolder()" class="btn-outline" style="width:auto; padding:0 12px; margin-bottom:0; height: 38px; display: flex; align-items: center;">â• æ–°å»º</button>
                <div style="width: 1px; height: 24px; background: #eee;"></div>
                <button onclick="deleteSelected()" class="btn-danger" style="width:auto; padding:0 12px; margin-bottom:0; height: 38px; display: flex; align-items: center;">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
            </div>

            <div id="folderBreadcrumb" style="font-size:0.85rem; color:#2563eb; margin-bottom:10px; font-weight:500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">/</div>
            <div id="folderList" style="flex:1; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; margin-bottom:10px; background: #f9fafb;"></div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <span style="font-size: 0.8rem; color: #666; align-self: center;" id="selectionCount"></span>
                <button onclick="confirmFolder()" style="width: auto;">âœ… é€‰æ‹©å½“å‰ç›®å½•</button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content" style="width: 600px; max-height: 80vh;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <strong>ğŸ“œ æ‰«æç»“æœè¯¦æƒ…</strong>
                <span onclick="document.getElementById('resultModal').style.display='none'" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <textarea id="resultText" style="width:100%; height:300px; font-family:monospace; font-size:0.85rem; padding:10px; border:1px solid #e5e7eb; border-radius:6px; background:#f9fafb; color:#374151; resize:vertical;" readonly></textarea>
            <div style="text-align:right; margin-top:10px;">
                <button onclick="document.getElementById('resultModal').style.display='none'">å…³é—­</button>
            </div>
        </div>
    </div>

<script>
    let adminToken = localStorage.getItem('adminToken');
    let curCid = "0", curPathName = "æ ¹ç›®å½•";
    let settingCatKey = null; // å½“å‰æ­£åœ¨è®¾ç½®å“ªä¸ªåˆ†ç±»çš„è·¯å¾„
    let catSettings = {}; // ç¼“å­˜åˆ†ç±»é…ç½®
    let allTasks = [];      // ç¼“å­˜ä»»åŠ¡åˆ—è¡¨ç”¨äºç¼–è¾‘å›æ˜¾
    let selectedFiles = new Set(); // é€‰ä¸­çš„æ–‡ä»¶IDé›†åˆ

    // åˆå§‹åŒ–
    (function init() {
        loadPublicSettings(); // åŠ è½½å…¬å¼€é…ç½®(å†³å®šUIæ˜¾ç¤º)
        if(adminToken) {
            document.getElementById('adminPanel').style.display = 'block';
            loadSettings();
        }
        loadTasks();
        setInterval(loadTasks, 5000);
    })();

    // ã€æ–°å¢ã€‘åŠ è½½å…¬å¼€é…ç½®ï¼Œæ§åˆ¶å®šæ—¶åŠŸèƒ½UIæ˜¾ç¤º
    async function loadPublicSettings() {
        const res = await request('/public-settings');
        if(res.success) {
            const show = res.enableCronFeature;
            const display = show ? 'block' : 'none';
            document.getElementById('createTaskCronSection').style.display = display;
            document.getElementById('editTaskCronSection').style.display = display;
        }
    }

    async function request(endpoint, method='GET', body=null) {
        const headers = { 'Content-Type': 'application/json' };
        if(adminToken) headers['x-admin-token'] = adminToken;
        try {
            const res = await fetch(`/api${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null });
            if(res.status === 403) { 
                // æƒé™å¤±æ•ˆï¼Œä½†ä¸å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œåªæ˜¯éšè—ç®¡ç†åŠŸèƒ½
                localStorage.removeItem('adminToken');
                adminToken = null;
                document.getElementById('adminPanel').style.display = 'none';
                return { success: false, msg: "ç®¡ç†å‘˜æƒé™å¤±æ•ˆ" }; 
            }
            return await res.json();
        } catch(e) { console.error(e); return { success: false, msg: "ç½‘ç»œé”™è¯¯" }; }
    }

    // --- ç®¡ç†å‘˜é€»è¾‘ ---
    function openAdminModal() {
        if(adminToken) {
            // å·²ç™»å½•åˆ™åˆ‡æ¢æ˜¾ç¤º/éšè—
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if(panel.style.display === 'block') loadSettings();
        } else {
            document.getElementById('adminLoginModal').style.display = 'flex';
        }
    }

    function logoutAdmin() {
        localStorage.removeItem('adminToken');
        adminToken = null;
        document.getElementById('adminPanel').style.display = 'none';
        loadTasks(); // åˆ·æ–°åˆ—è¡¨ä»¥éšè—ç®¡ç†æŒ‰é’®
    }

    async function doAdminLogin() {
        const u = document.getElementById('adminUser').value;
        const p = document.getElementById('adminPwd').value;
        const res = await request('/admin/login', 'POST', { username: u, password: p });
        if(res.success) {
            adminToken = res.token;
            localStorage.setItem('adminToken', adminToken);
            document.getElementById('adminLoginModal').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadSettings();
            loadTasks(); // åˆ·æ–°åˆ—è¡¨ä»¥æ˜¾ç¤ºç®¡ç†æŒ‰é’®
        } else alert(res.msg);
    }

    async function loadSettings() {
        const res = await request('/settings');
        if(res.success && res.data) {
            document.getElementById('cookieInput').value = res.data.cookie || '';
            document.getElementById('setEnableCronFeature').checked = !!res.data.enableCronFeature;
            
            catSettings = res.data; // ç¼“å­˜æ‰€æœ‰æ•°æ®
            document.getElementById('catTvName').value = res.data.catTvName || 'æœªè®¾ç½®';
            document.getElementById('catMovieName').value = res.data.catMovieName || 'æœªè®¾ç½®';
            document.getElementById('catVarietyName').value = res.data.catVarietyName || 'æœªè®¾ç½®';
            document.getElementById('catAnimeName').value = res.data.catAnimeName || 'æœªè®¾ç½®';
            document.getElementById('catOtherName').value = res.data.catOtherName || 'æœªè®¾ç½®';

            document.getElementById('setAdminUser').value = res.data.adminUser || 'admin';
            document.getElementById('setAdminPass').value = res.data.adminPass || 'admin';
            document.getElementById('olUrl').value = res.data.olUrl || '';
            document.getElementById('olToken').value = res.data.olToken || '';
            document.getElementById('olMountPrefix').value = res.data.olMountPrefix || '';
        }
    }

    async function saveSettings() {
        const cookie = document.getElementById('cookieInput').value;
        const adminUser = document.getElementById('setAdminUser').value;
        const adminPass = document.getElementById('setAdminPass').value;
        const enableCronFeature = document.getElementById('setEnableCronFeature').checked;
        
        const olUrl = document.getElementById('olUrl').value;
        const olToken = document.getElementById('olToken').value;
        const olMountPrefix = document.getElementById('olMountPrefix').value;
        
        // æ„é€ åˆ†ç±»é…ç½®
        const cats = {
            catTvCid: catSettings.catTvCid, catTvName: catSettings.catTvName,
            catMovieCid: catSettings.catMovieCid, catMovieName: catSettings.catMovieName,
            catVarietyCid: catSettings.catVarietyCid, catVarietyName: catSettings.catVarietyName,
            catAnimeCid: catSettings.catAnimeCid, catAnimeName: catSettings.catAnimeName,
            catOtherCid: catSettings.catOtherCid, catOtherName: catSettings.catOtherName,
        };

        const res = await request('/settings', 'POST', { cookie, cats, adminUser, adminPass, olUrl, olToken, olMountPrefix, enableCronFeature });
        if(res.success) {
            alert("è®¾ç½®å·²ä¿å­˜");
            loadPublicSettings(); // ç«‹å³åˆ·æ–°UIçŠ¶æ€
        } else alert(res.msg);
    }

    // --- Cron å·¥å…· ---
    function toggleCronInput() {
        const enabled = document.getElementById('enableCron').checked;
        document.getElementById('cronInputBox').style.display = enabled ? 'block' : 'none';
    }

    function updateCronPreview(mode) {
        const inputId = mode === 'edit' ? 'edit_cron_hours' : 'cron_hours';
        const resultId = mode === 'edit' ? 'editCronResult' : 'cronResult';
        
        const val = document.getElementById(inputId).value.trim();
        
        if (!val) {
            document.getElementById(resultId).innerText = "æ‰§è¡Œç­–ç•¥: " + (mode === 'edit' ? "æ—  (åœæ­¢å®šæ—¶)" : "ä»…ä¸€æ¬¡ (ç«‹å³æ‰§è¡Œ)");
            document.getElementById(resultId).style.color = "#6b7280";
            return "";
        }
        
        // æ„é€  Cron: 0 {hours} * * *
        const cronStr = `0 ${val} * * *`;
        let desc = `Cron: ${cronStr} (æ¯å¤© ${val} ç‚¹)`;
        
        document.getElementById(resultId).innerText = desc;
        document.getElementById(resultId).style.color = "#10b981";
        return cronStr;
    }

    function clearCron(mode) {
        const inputId = mode === 'edit' ? 'edit_cron_hours' : 'cron_hours';
        document.getElementById(inputId).value = '';
        updateCronPreview(mode);
    }

    // --- ä»»åŠ¡æ“ä½œ ---

    async function createTask() {
        // åªæœ‰å½“åŒºåŸŸå¯è§æ—¶ï¼Œæ‰è¯»å–å‹¾é€‰çŠ¶æ€
        const isCronVisible = document.getElementById('createTaskCronSection').style.display !== 'none';
        const enableCron = isCronVisible && document.getElementById('enableCron').checked;
        const cronExpression = enableCron ? updateCronPreview('create') : '';
        const categoryInput = document.querySelector('input[name="category"]:checked');
        if(!categoryInput) return alert("è¯·é€‰æ‹©ä¿å­˜åˆ†ç±»");
        
        const payload = {
            taskName: document.getElementById('taskName').value,
            shareUrl: document.getElementById('shareUrl').value,
            password: document.getElementById('accessCode').value,
            category: categoryInput.value,
            cronExpression: cronExpression
        };
        if(!payload.taskName) return alert("ä»»åŠ¡åç§°ä¸èƒ½ä¸ºç©º");
        if(!payload.shareUrl) return alert("åˆ†äº«é“¾æ¥ä¸èƒ½ä¸ºç©º");
        const res = await request('/task', 'POST', payload);
        if(res.success) {
            document.getElementById('taskName').value = '';
            document.getElementById('shareUrl').value = '';
            alert('âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œå·²å¼€å§‹é¦–æ¬¡æ‰§è¡Œ'); loadTasks();
        } else alert("âŒ å¤±è´¥: " + res.msg);
    }
    
    // ã€æ–°å¢ã€‘æ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡å‡½æ•°
    async function runTaskNow(id) {
        const task = allTasks.find(t => t.id === id);
        if(!task) return alert('ä»»åŠ¡ä¸å­˜åœ¨');
        if(task.status === 'running') return alert('ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç¨å€™');
        
        if(confirm(`ç¡®å®šç«‹å³æ‰§è¡Œä»»åŠ¡: ${task.taskName}?`)) {
            // æ–°å¢ä¸€ä¸ª PUT æ¥å£æ¥è§¦å‘ processTask
            const res = await request(`/task/${id}/run`, 'PUT');
            if(res.success) {
                alert('âœ… ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç­‰å¾…çŠ¶æ€åˆ·æ–°');
                loadTasks();
            } else {
                alert("âŒ å¯åŠ¨å¤±è´¥: " + res.msg);
            }
        }
    }

    // ã€æ–°å¢ã€‘æ‰«æç™¾åº¦ç½‘ç›˜
    async function scanBaidu() {
        if(!confirm('ç¡®å®šè¦æ‰«æ OpenList çš„ /ç™¾åº¦ç½‘ç›˜ è·¯å¾„å—ï¼Ÿ')) return;
        const res = await request('/scan/path', 'POST', { path: '/ç™¾åº¦ç½‘ç›˜' });
        if(res.success) {
            alert('âœ… æ‰«æè¯·æ±‚å·²å‘é€');
        } else {
            alert("âŒ å¤±è´¥: " + res.msg);
        }
    }

    // ã€æ¢å¤ã€‘æ‰‹åŠ¨è§¦å‘æ‰«æ (è°ƒç”¨åç«¯)
    async function refreshIndex(id) {
        // ç§»é™¤ç¡®è®¤å¼¹çª—ï¼Œç›´æ¥æ‰§è¡Œ
        const res = await request(`/task/${id}/refresh-index`, 'POST');
        
        if(res.success) {
            loadTasks(); // åˆ·æ–°åˆ—è¡¨ï¼Œç»“æœä¼šæ˜¾ç¤ºåœ¨ä»»åŠ¡æ—¥å¿—ä¸­
        } else {
            alert("âŒ å¤±è´¥: " + res.msg);
        }
    }

    async function loadTasks() {
        const tasks = await request('/tasks');
        allTasks = tasks; // ç¼“å­˜
        const isAdmin = !!localStorage.getItem('adminToken');
        
        // æ§åˆ¶æ¸…ç©ºæŒ‰é’®æ˜¾ç¤º
        const btnClear = document.getElementById('btnClearAll');
        if(btnClear) btnClear.style.display = isAdmin ? 'block' : 'none';

        const html = tasks.map(t => `
            <div class="task-item ${t.status}">
                <div class="task-header">
                    <div>
                        <a href="${t.shareUrl || '#'}" target="_blank" class="task-link" title="ä¸Šæ¬¡æˆåŠŸ: ${t.lastSuccessDate || 'æ— '}">
                            ${t.status === 'scheduled' ? 'â³' : (t.status==='success'?'âœ…':'â–¶ï¸')} ${t.taskName || 'æœªå‘½å'} ğŸ”—
                        </a>
                        <div class="task-meta">
                            <span>â±ï¸ ${t.cronExpression ? t.cronExpression : 'æ‰‹åŠ¨'}</span>
                            <span style="margin-left:10px; color:#9ca3af;" title="åˆ›å»ºäººIP">ğŸ‘¤ ${t.creatorIp || 'æœªçŸ¥IP'}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        ${isAdmin ? `
                            ${t.status !== 'running' ? `<button onclick="runTaskNow(${t.id})" class="btn-run" style="width:auto; padding:4px 10px; font-size:0.8rem;">æ‰§è¡Œ</button>` : ''}
                            <button onclick="refreshIndex(${t.id})" class="btn-refresh" style="width:auto; padding:4px 10px; font-size:0.8rem;" title="é€šçŸ¥OpenListæ‰«æ">æ‰«æ</button>
                            <button onclick="openEditModal(${t.id})" class="btn-edit" style="width:auto; padding:4px 10px; font-size:0.8rem;">ç¼–è¾‘</button>
                            <button onclick="deleteTask(${t.id})" class="btn-danger" style="width:auto; padding:4px 10px; font-size:0.8rem;">åˆ é™¤</button>
                        ` : ''}
                    </div>
                </div>
                <div class="task-log">${t.log || 'ç­‰å¾…ä¸­...'}</div>
            </div>
        `).join('');
        document.getElementById('taskList').innerHTML = html || '<div style="text-align:center; color:#999;">æš‚æ— ä»»åŠ¡</div>';
    }

    async function deleteTask(id) {
        if(confirm('ç¡®å®šåˆ é™¤?')) { await request(`/task/${id}`, 'DELETE'); loadTasks(); }
    }

    async function clearAllTasks() {
        if(!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å—ï¼Ÿ\næ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡è®°å½•å¹¶åœæ­¢ç›¸å…³å®šæ—¶å™¨ï¼Œä¸”ä¸å¯æ¢å¤ï¼')) return;
        const res = await request('/tasks', 'DELETE');
        if(res.success) {
            alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡');
            loadTasks();
        } else {
            alert("âŒ æ“ä½œå¤±è´¥: " + res.msg);
        }
    }

    // --- ç¼–è¾‘åŠŸèƒ½ ---

    function openEditModal(id) {
        const task = allTasks.find(t => t.id === id);
        if(!task) return;

        document.getElementById('editTaskId').value = id;
        document.getElementById('editTaskName').value = task.taskName || '';
        document.getElementById('editShareUrl').value = task.shareUrl || '';
        document.getElementById('editAccessCode').value = task.receiveCode || '';

        // è¿˜åŸ Cron
        if (task.cronExpression) {
            const parts = task.cronExpression.split(' ');
            if (parts.length >= 2) {
                document.getElementById('edit_cron_hours').value = parts[1];
            }
        } else {
            clearCron('edit');
        }
        updateCronPreview('edit');
        
        document.getElementById('editModal').style.display = 'flex';
    }

    async function updateTask() {
        const id = document.getElementById('editTaskId').value;
        const cronExp = updateCronPreview('edit');
        
        const payload = {
            taskName: document.getElementById('editTaskName').value,
            shareUrl: document.getElementById('editShareUrl').value,
            password: document.getElementById('editAccessCode').value,
            cronExpression: cronExp
        };

        const res = await request(`/task/${id}`, 'PUT', payload);
        if(res.success) {
            document.getElementById('editModal').style.display = 'none';
            alert('âœ… ä»»åŠ¡æ›´æ–°æˆåŠŸ');
            loadTasks();
        } else {
            alert("æ›´æ–°å¤±è´¥: " + res.msg);
        }
    }

    // --- ç›®å½•é€‰æ‹© ---

    async function openFolderPicker(catKey) {
        settingCatKey = catKey;
        document.getElementById('folderModal').style.display = 'flex';
        // ä¸ä¼ å‚æ•°ï¼Œè®©åç«¯ä½¿ç”¨é»˜è®¤é…ç½®çš„æ ¹ç›®å½•
        loadFolders(); 
    }

    async function loadFolders(cid) {
        const listDiv = document.getElementById('folderList');
        listDiv.innerHTML = '<div style="padding:10px;">åŠ è½½ä¸­...</div>';
        selectedFiles.clear(); updateSelectionUI();
        
        const url = cid ? `/folders?cid=${cid}` : '/folders';
        const res = await request(url);
        
        if(res.success) {
            systemRootCid = res.rootCid || "0"; // æ›´æ–°ç³»ç»Ÿæ ¹ç›®å½•CID
            const paths = res.data.path || [];
            
            // å¦‚æœæ˜¯åˆå§‹åŠ è½½(æ— cid)ï¼Œåˆ™ä»è¿”å›çš„ path ä¸­è·å–å½“å‰ cid (å³åå°è®¾ç½®çš„æ ¹ç›®å½•)
            if (paths.length > 0) {
                curCid = paths[paths.length - 1].cid;
            } else {
                curCid = cid || "0";
            }

            curPathName = paths.length ? paths.map(p=>p.name).join(' > ') : 'æ ¹ç›®å½•';
            document.getElementById('folderBreadcrumb').innerText = curPathName;
            
            // è®¡ç®—ä¸Šä¸€çº§ç›®å½•
            let parentCid = (paths.length > 1) ? paths[paths.length-2].cid : '0';
            // ã€ä¿®æ”¹ã€‘åªæœ‰å½“å½“å‰ç›®å½•ä¸æ˜¯ç³»ç»Ÿæ ¹ç›®å½•æ—¶ï¼Œæ‰æ˜¾ç¤ºè¿”å›ä¸Šä¸€çº§
            let html = (curCid !== '0' && curCid !== systemRootCid) ? `<div style="padding:10px; cursor:pointer; background:#f9fafb;" onclick="loadFolders('${parentCid}')">â¬…ï¸ è¿”å›ä¸Šä¸€çº§</div>` : '';
            
            res.data.list.forEach(f => {
                const isFolder = f.type === 'folder';
                const icon = isFolder ? 'ğŸ“' : 'ğŸ“„';
                // æ–‡ä»¶å¤¹ç‚¹å‡»åå­—è¿›å…¥ï¼Œæ–‡ä»¶ç‚¹å‡»æ— åŠ¨ä½œ(æˆ–é¢„è§ˆ)
                // Checkbox ç”¨äºé€‰æ‹©
                html += `
                    <div class="file-item" style="padding:8px 10px; border-bottom:1px solid #eee; display:flex; align-items:center; gap:8px; cursor:default;">
                        <input type="checkbox" value="${f.id}" onchange="toggleSelection('${f.id}')" style="width:auto; margin:0; cursor:pointer;">
                        <span style="cursor:${isFolder ? 'pointer' : 'default'}; flex:1; display:flex; align-items:center; gap:5px;" onclick="${isFolder ? `loadFolders('${f.cid}')` : ''}">
                            <span>${icon}</span>
                            <span style="${isFolder ? 'font-weight:500; color:#374151;' : 'color:#6b7280;'}">${f.name}</span>
                        </span>
                    </div>
                `;
            });
            listDiv.innerHTML = html || '<div style="padding:10px;">ç©ºæ–‡ä»¶å¤¹</div>';
        } else {
            listDiv.innerHTML = '<div style="padding:10px; color:red;">åŠ è½½å¤±è´¥</div>';
        }
    }

    function toggleSelection(id) {
        if(selectedFiles.has(id)) selectedFiles.delete(id);
        else selectedFiles.add(id);
        updateSelectionUI();
    }

    function updateSelectionUI() {
        const count = selectedFiles.size;
        document.getElementById('selectionCount').innerText = count > 0 ? `å·²é€‰ ${count} é¡¹` : '';
    }

    async function deleteSelected() {
        if(selectedFiles.size === 0) return alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶/æ–‡ä»¶å¤¹");
        if(!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedFiles.size} é¡¹å—ï¼Ÿ(å°†ç§»å…¥å›æ”¶ç«™)`)) return;
        
        const res = await request('/files/delete', 'POST', { fileIds: Array.from(selectedFiles) });
        if(res.success) {
            alert('åˆ é™¤æˆåŠŸ');
            loadFolders(curCid);
        } else {
            alert("åˆ é™¤å¤±è´¥: " + res.msg);
        }
    }

    async function createNewFolder() {
        const name = document.getElementById('newFolderName').value;
        if(!name) return alert("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°");
        
        const res = await request('/folder', 'POST', { parentCid: curCid, folderName: name });
        if(res.success) {
            alert('åˆ›å»ºæˆåŠŸ');
            document.getElementById('newFolderName').value = '';
            loadFolders(res.cid); // è‡ªåŠ¨è¿›å…¥æ–°åˆ›å»ºçš„æ–‡ä»¶å¤¹
        } else {
            alert("åˆ›å»ºå¤±è´¥: " + res.msg);
        }
    }

    function confirmFolder() {
        if (settingCatKey) {
            // æ›´æ–°ç¼“å­˜å¯¹è±¡
            catSettings[`cat${capitalize(settingCatKey)}Cid`] = curCid;
            catSettings[`cat${capitalize(settingCatKey)}Name`] = curPathName;
            // æ›´æ–°UI
            document.getElementById(`cat${capitalize(settingCatKey)}Name`).value = curPathName;
        }
        document.getElementById('folderModal').style.display = 'none';
    }

    function capitalize(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
    }
</script>
</body>
</html>
